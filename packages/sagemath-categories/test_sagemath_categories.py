# best tested after installing pytest-xdist
# pytest -n auto ...
import pytest
from pytest_pyodide import run_in_pyodide


@run_in_pyodide(packages=["sagemath-categories"])
def test_sagemath_categories(selenium):
    pass


# @pytest.mark.driver_timeout(3600)
@pytest.mark.parametrize(
    "files",
    [
        ["misc/package.py"],
        ["misc/superseded.py"],
        ["misc/temporary_file.py"],
        ["misc/prandom.py"],
        ["misc/verbose.py"],
        ["misc/classcall_metaclass.pyx"],
        ["misc/misc.py"],
        ["misc/viewer.py"],
        ["misc/weak_dict.pyx"],
        ["misc/flatten.py"],
        ["misc/package_dir.py"],
        ["misc/lazy_string.pyx"],
        ["misc/c3_controlled.pyx"],
        ["misc/lazy_import_cache.py"],
        ["misc/instancedoc.pyx"],
        ["misc/function_mangling.pyx"],
        ["misc/all__sagemath_repl.py"],
        ["misc/fast_methods.pyx"],
        ["misc/cachefunc.pyx"],
        ["misc/repr.py"],
        ["misc/randstate.pyx"],
        ["misc/inherit_comparison.pyx"],
        ["misc/sagedoc.py"],
        ["misc/bindable_class.py"],
        ["misc/nested_class.pyx"],
        ["misc/misc_c.pyx"],
        ["misc/timing.py"],
        ["misc/lazy_attribute.pyx"],
        ["misc/lazy_import.pyx"],
        ["misc/abstract_method.py"],
        ["misc/sageinspect.py"],
        ["misc/namespace_package.py"],
        ["misc/sage_eval.py"],
        ["misc/persist.pyx"],
        ["misc/call.py"],
        ["misc/all__sagemath_environment.py"],
        ["misc/all__sagemath_objects.py"],
        ["misc/lazy_format.py"],
        ["misc/sage_unittest.py"],
        ["misc/unknown.py"],
        ["misc/banner.py"],
        ["misc/constant_function.pyx"],
        ["misc/sage_input.py"],
        ["misc/decorators.py"],
        ["version.py"],
        ["env.py"],
        ["all__sagemath_categories.py"],
        ["ext/all__sagemath_objects.py"],
        ["doctest/parsing.py"],
        ["doctest/util.py"],
        ["doctest/control.py"],
        ["doctest/__init__.py"],
        ["doctest/all.py"],
        ["doctest/test.py"],
        ["doctest/sources.py"],
        ["doctest/parsing_test.py"],
        ["doctest/forker.py"],
        ["doctest/external.py"],
        ["doctest/fixtures.py"],
        ["doctest/reporting.py"],
        ["features/join_feature.py"],
        ["features/interfaces.py"],
        ["features/palp.py"],
        ["features/sphinx.py"],
        ["features/symengine_py.py"],
        ["features/databases.py"],
        ["features/singular.py"],
        ["features/cython.py"],
        ["features/poppler.py"],
        ["features/internet.py"],
        ["features/normaliz.py"],
        ["features/graphviz.py"],
        ["features/sagemath.py"],
        ["features/jmol.py"],
        ["features/standard.py"],
        ["features/pandoc.py"],
        ["features/four_ti_2.py"],
        ["features/rubiks.py"],
        ["features/imagemagick.py"],
        ["features/cddlib.py"],
        ["features/polymake.py"],
        ["features/csdp.py"],
        ["features/lrs.py"],
        ["features/ffmpeg.py"],
        ["features/__init__.py"],
        ["features/kenzo.py"],
        ["features/all.py"],
        ["features/dvipng.py"],
        ["features/meataxe.py"],
        ["features/igraph.py"],
        ["features/gfan.py"],
        ["features/mip_backends.py"],
        ["features/tdlib.py"],
        ["features/bliss.py"],
        ["features/pdf2svg.py"],
        ["features/mcqd.py"],
        ["features/fricas.py"],
        ["features/gap.py"],
        ["features/nauty.py"],
        ["features/phitigra.py"],
        ["features/msolve.py"],
        ["features/latte.py"],
        ["features/latex.py"],
        ["features/threejs.py"],
        ["features/graph_generators.py"],
        ["features/pkg_systems.py"],
        ["all__sagemath_repl.py"],
        ["repl/configuration.py"],
        ["repl/attach.py"],
        ["repl/__init__.py"],
        ["repl/all.py"],
        ["repl/preparse.py"],
        ["repl/prompts.py"],
        ["repl/interpreter.py"],
        ["repl/ipython_kernel/widgets_sagenb.py"],
        ["repl/ipython_kernel/kernel.py"],
        ["repl/ipython_kernel/__init__.py"],
        ["repl/ipython_kernel/widgets.py"],
        ["repl/ipython_kernel/all_jupyter.py"],
        ["repl/ipython_kernel/install.py"],
        ["repl/ipython_kernel/interact.py"],
        ["repl/ipython_kernel/__main__.py"],
        ["repl/interface_magic.py"],
        ["repl/inputhook.py"],
        ["repl/ipython_extension.py"],
        ["repl/display/formatter.py"],
        ["repl/display/util.py"],
        ["repl/display/pretty_print.py"],
        ["repl/display/__init__.py"],
        ["repl/display/fancy_repr.py"],
        ["repl/display/jsmol_iframe.py"],
        ["repl/load.py"],
        ["repl/rich_output/test_backend.py"],
        ["repl/rich_output/output_video.py"],
        ["repl/rich_output/backend_base.py"],
        ["repl/rich_output/pretty_print.py"],
        ["repl/rich_output/output_basic.py"],
        ["repl/rich_output/backend_emacs.py"],
        ["repl/rich_output/preferences.py"],
        ["repl/rich_output/__init__.py"],
        ["repl/rich_output/output_browser.py"],
        ["repl/rich_output/backend_ipython.py"],
        ["repl/rich_output/output_graphics3d.py"],
        ["repl/rich_output/backend_doctest.py"],
        ["repl/rich_output/buffer.py"],
        ["repl/rich_output/display_manager.py"],
        ["repl/rich_output/output_graphics.py"],
        ["repl/rich_output/output_catalog.py"],
        ["repl/image.py"],
        ["repl/ipython_tests.py"],
        ["repl/user_globals.py"],
        ["groups/all__sagemath_objects.py"],
        ["arith/power.pyx"],
        ["arith/numerical_approx.pyx"],
        ["arith/all__sagemath_objects.py"],
        ["libs/gmp/__init__.py"],
        ["libs/gmp/pylong.pyx"],
        ["libs/all__sagemath_objects.py"],
        ["cpython/dict_del_by_value.pyx"],
        ["cpython/type.pyx"],
        ["cpython/debug.pyx"],
        ["cpython/__init__.py"],
        ["cpython/builtin_types.pyx"],
        ["cpython/all.py"],
        ["cpython/string.pyx"],
        ["cpython/cython_metaclass.pyx"],
        ["cpython/_py2_random.py"],
        ["cpython/wrapperdescr.pyx"],
        ["cpython/getattr.pyx"],
        ["cpython/atexit.pyx"],
        ["sets/pythonclass.pyx"],
        ["sets/all__sagemath_objects.py"],
        ["rings/all__sagemath_categories.py"],
        ["rings/ideal.py"],
        ["rings/ring.pyx"],
        ["rings/all__sagemath_objects.py"],
        ["typeset/unicode_art.py"],
        ["typeset/character_art_factory.py"],
        ["typeset/character_art.py"],
        ["typeset/all.py"],
        ["typeset/symbols.py"],
        ["typeset/unicode_characters.py"],
        ["typeset/ascii_art.py"],
        ["all__sagemath_environment.py"],
        ["modules/all__sagemath_objects.py"],
        ["structure/gens_py.py"],
        ["structure/proof/__init__.py"],
        ["structure/proof/all.py"],
        ["structure/proof/proof.py"],
        ["structure/sage_object_test.py"],
        ["structure/support_view.py"],
        ["structure/coerce_actions.pyx"],
        ["structure/parent_base.pyx"],
        ["structure/parent_old.pyx"],
        ["structure/element.pyx"],
        ["structure/factory.pyx"],
        ["structure/dynamic_class.py"],
        ["structure/mutability.pyx"],
        ["structure/unique_representation.py"],
        ["structure/sequence.py"],
        ["structure/global_options.py"],
        ["structure/test_factory.py"],
        ["structure/parent_gens.pyx"],
        ["structure/set_factories.py"],
        ["structure/__init__.py"],
        ["structure/list_clone_timings.py"],
        ["structure/factorization_integer.py"],
        ["structure/coerce.pyx"],
        ["structure/all.py"],
        ["structure/element_wrapper.pyx"],
        ["structure/factorization.py"],
        ["structure/coerce_dict.pyx"],
        ["structure/indexed_generators.py"],
        ["structure/list_clone_demo.pyx"],
        ["structure/debug_options.pyx"],
        ["structure/coerce_exceptions.py"],
        ["structure/formal_sum.py"],
        ["structure/category_object.pyx"],
        ["structure/list_clone_timings_cy.pyx"],
        ["structure/richcmp.pyx"],
        ["structure/coerce_maps.pyx"],
        ["structure/nonexact.py"],
        ["structure/sage_object.pyx"],
        ["structure/list_clone.pyx"],
        ["structure/set_factories_example.py"],
        ["structure/parent.pyx"],
        ["all__sagemath_objects.py"],
        ["categories/loop_crystals.py"],
        ["categories/category_cy_helper.pyx"],
        ["categories/action.pyx"],
        ["categories/j_trivial_semigroups.py"],
        ["categories/finite_fields.py"],
        ["categories/kac_moody_algebras.py"],
        ["categories/coxeter_group_algebras.py"],
        ["categories/super_algebras_with_basis.py"],
        ["categories/division_rings.py"],
        ["categories/filtered_algebras.py"],
        ["categories/posets.py"],
        ["categories/supercrystals.py"],
        ["categories/metric_spaces.py"],
        ["categories/generalized_coxeter_groups.py"],
        ["categories/super_modules.py"],
        ["categories/finite_coxeter_groups.py"],
        ["categories/finite_semigroups.py"],
        ["categories/coalgebras.py"],
        ["categories/discrete_valuation.py"],
        ["categories/hecke_modules.py"],
        ["categories/filtered_modules_with_basis.py"],
        ["categories/lambda_bracket_algebras.py"],
        ["categories/algebra_functor.py"],
        ["categories/finite_permutation_groups.py"],
        ["categories/quotients.py"],
        ["categories/facade_sets.py"],
        ["categories/h_trivial_semigroups.py"],
        ["categories/commutative_additive_semigroups.py"],
        ["categories/signed_tensor.py"],
        ["categories/vector_bundles.py"],
        ["categories/magmatic_algebras.py"],
        ["categories/algebras.py"],
        ["categories/fields.py"],
        ["categories/complex_reflection_or_generalized_coxeter_groups.py"],
        ["categories/finitely_generated_semigroups.py"],
        ["categories/matrix_algebras.py"],
        ["categories/tutorial.py"],
        ["categories/algebra_ideals.py"],
        ["categories/super_modules_with_basis.py"],
        ["categories/filtered_modules.py"],
        ["categories/finitely_generated_magmas.py"],
        ["categories/magmas.py"],
        ["categories/finite_dimensional_hopf_algebras_with_basis.py"],
        ["categories/finite_posets.py"],
        ["categories/additive_semigroups.py"],
        ["categories/functor.pyx"],
        ["categories/primer.py"],
        ["categories/sets_cat.py"],
        ["categories/subobjects.py"],
        ["categories/sets_with_partial_maps.py"],
        ["categories/regular_crystals.py"],
        ["categories/super_hopf_algebras_with_basis.py"],
        ["categories/lattice_posets.py"],
        ["categories/finite_groups.py"],
        ["categories/bialgebras.py"],
        ["categories/gcd_domains.py"],
        ["categories/complete_discrete_valuation.py"],
        ["categories/lie_groups.py"],
        ["categories/realizations.py"],
        ["categories/principal_ideal_domains.py"],
        ["categories/bimodules.py"],
        ["categories/graded_coalgebras_with_basis.py"],
        ["categories/weyl_groups.py"],
        ["categories/graded_modules_with_basis.py"],
        ["categories/graded_bialgebras_with_basis.py"],
        ["categories/vector_spaces.py"],
        ["categories/sets_with_grading.py"],
        ["categories/category_singleton.pyx"],
        ["categories/homsets.py"],
        ["categories/commutative_ring_ideals.py"],
        ["categories/isomorphic_objects.py"],
        ["categories/monoid_algebras.py"],
        ["categories/domains.py"],
        ["categories/finite_dimensional_modules_with_basis.py"],
        ["categories/infinite_enumerated_sets.py"],
        ["categories/classical_crystals.py"],
        ["categories/pushout.py"],
        ["categories/finite_enumerated_sets.py"],
        ["categories/simplicial_complexes.py"],
        ["categories/monoids.py"],
        ["categories/finite_monoids.py"],
        ["categories/enumerated_sets.py"],
        ["categories/supercommutative_algebras.py"],
        ["categories/commutative_algebra_ideals.py"],
        ["categories/category_types.py"],
        ["categories/graded_lie_conformal_algebras.py"],
        ["categories/dual.py"],
        ["categories/pointed_sets.py"],
        ["categories/quotient_fields.py"],
        ["categories/triangular_kac_moody_algebras.py"],
        ["categories/modular_abelian_varieties.py"],
        ["categories/map.pyx"],
        ["categories/graded_lie_algebras_with_basis.py"],
        ["categories/all.py"],
        ["categories/finite_complex_reflection_groups.py"],
        ["categories/g_sets.py"],
        ["categories/finite_crystals.py"],
        ["categories/coercion_methods.pyx"],
        ["categories/groups.py"],
        ["categories/l_trivial_semigroups.py"],
        ["categories/semirings.py"],
        ["categories/finite_weyl_groups.py"],
        ["categories/tensor.py"],
        ["categories/commutative_additive_groups.py"],
        ["categories/unital_algebras.py"],
        ["categories/lie_conformal_algebras_with_basis.py"],
        ["categories/super_algebras.py"],
        ["categories/graded_algebras_with_basis.py"],
        ["categories/associative_algebras.py"],
        ["categories/finite_dimensional_nilpotent_lie_algebras_with_basis.py"],
        ["categories/lie_algebras.py"],
        ["categories/r_trivial_semigroups.py"],
        ["categories/number_fields.py"],
        ["categories/manifolds.py"],
        ["categories/additive_magmas.py"],
        ["categories/graded_coalgebras.py"],
        ["categories/finite_dimensional_lie_algebras_with_basis.py"],
        ["categories/homset.py"],
        ["categories/finite_dimensional_semisimple_algebras_with_basis.py"],
        ["categories/basic.py"],
        ["categories/magmas_and_additive_magmas.py"],
        ["categories/finite_sets.py"],
        ["categories/affine_weyl_groups.py"],
        ["categories/hopf_algebras.py"],
        ["categories/lie_algebras_with_basis.py"],
        ["categories/finite_dimensional_graded_lie_algebras_with_basis.py"],
        ["categories/examples/semigroups_cython.pyx"],
        ["categories/examples/posets.py"],
        ["categories/examples/graded_connected_hopf_algebras_with_basis.py"],
        ["categories/examples/finite_coxeter_groups.py"],
        ["categories/examples/finite_semigroups.py"],
        ["categories/examples/filtered_modules_with_basis.py"],
        ["categories/examples/facade_sets.py"],
        ["categories/examples/commutative_additive_semigroups.py"],
        ["categories/examples/magmas.py"],
        ["categories/examples/sets_cat.py"],
        ["categories/examples/graded_modules_with_basis.py"],
        ["categories/examples/sets_with_grading.py"],
        ["categories/examples/infinite_enumerated_sets.py"],
        ["categories/examples/finite_enumerated_sets.py"],
        ["categories/examples/monoids.py"],
        ["categories/examples/finite_monoids.py"],
        ["categories/examples/all.py"],
        ["categories/examples/finite_weyl_groups.py"],
        ["categories/examples/lie_algebras.py"],
        ["categories/examples/manifolds.py"],
        ["categories/examples/finite_dimensional_lie_algebras_with_basis.py"],
        ["categories/examples/lie_algebras_with_basis.py"],
        ["categories/examples/hopf_algebras_with_basis.py"],
        ["categories/examples/filtered_algebras_with_basis.py"],
        ["categories/examples/algebras_with_basis.py"],
        ["categories/examples/crystals.py"],
        ["categories/examples/commutative_additive_monoids.py"],
        ["categories/examples/graphs.py"],
        ["categories/examples/semigroups.py"],
        ["categories/examples/with_realizations.py"],
        ["categories/examples/cw_complexes.py"],
        ["categories/examples/coxeter_groups.py"],
        ["categories/examples/finite_dimensional_algebras_with_basis.py"],
        ["categories/function_fields.py"],
        ["categories/hopf_algebras_with_basis.py"],
        ["categories/schemes.py"],
        ["categories/distributive_magmas_and_additive_magmas.py"],
        ["categories/aperiodic_semigroups.py"],
        ["categories/finitely_generated_lie_conformal_algebras.py"],
        ["categories/covariant_functorial_construction.py"],
        ["categories/semisimple_algebras.py"],
        ["categories/simplicial_sets.py"],
        ["categories/filtered_algebras_with_basis.py"],
        ["categories/finitely_generated_lambda_bracket_algebras.py"],
        ["categories/bialgebras_with_basis.py"],
        ["categories/unique_factorization_domains.py"],
        ["categories/graded_hopf_algebras.py"],
        ["categories/euclidean_domains.py"],
        ["categories/complex_reflection_groups.py"],
        ["categories/coalgebras_with_basis.py"],
        ["categories/algebra_modules.py"],
        ["categories/algebras_with_basis.py"],
        ["categories/category_with_axiom.py"],
        ["categories/quantum_group_representations.py"],
        ["categories/ring_ideals.py"],
        ["categories/chain_complexes.py"],
        ["categories/right_modules.py"],
        ["categories/polyhedra.py"],
        ["categories/super_lie_conformal_algebras.py"],
        ["categories/crystals.py"],
        ["categories/modules.py"],
        ["categories/finite_lattice_posets.py"],
        ["categories/commutative_additive_monoids.py"],
        ["categories/highest_weight_crystals.py"],
        ["categories/partially_ordered_monoids.py"],
        ["categories/rings.py"],
        ["categories/regular_supercrystals.py"],
        ["categories/poor_man_map.py"],
        ["categories/rngs.py"],
        ["categories/morphism.pyx"],
        ["categories/group_algebras.py"],
        ["categories/lambda_bracket_algebras_with_basis.py"],
        ["categories/additive_monoids.py"],
        ["categories/cartesian_product.py"],
        ["categories/objects.py"],
        ["categories/drinfeld_modules.py"],
        ["categories/graphs.py"],
        ["categories/groupoid.py"],
        ["categories/commutative_algebras.py"],
        ["categories/additive_groups.py"],
        ["categories/left_modules.py"],
        ["categories/semigroups.py"],
        ["categories/with_realizations.py"],
        ["categories/graded_lie_algebras.py"],
        ["categories/cw_complexes.py"],
        ["categories/shephard_groups.py"],
        ["categories/coxeter_groups.py"],
        ["categories/all__sagemath_objects.py"],
        ["categories/modules_with_basis.py"],
        ["categories/commutative_rings.py"],
        ["categories/graded_modules.py"],
        ["categories/topological_spaces.py"],
        ["categories/subquotients.py"],
        ["categories/permutation_groups.py"],
        ["categories/filtered_hopf_algebras_with_basis.py"],
        ["categories/finite_dimensional_algebras_with_basis.py"],
        ["categories/category.py"],
        ["categories/graded_bialgebras.py"],
        ["categories/graded_hopf_algebras_with_basis.py"],
        ["categories/finite_dimensional_coalgebras_with_basis.py"],
        ["categories/graded_algebras.py"],
        ["categories/lie_conformal_algebras.py"],
        ["categories/finite_dimensional_bialgebras_with_basis.py"],
        ["categories/integral_domains.py"],
    ],
)
@run_in_pyodide(packages=["sagemath-categories", "sagemath-repl"])
def test_sagemath_categories_doctests(selenium, files):
    from pathlib import Path

    import sage.env
    from sage.doctest.control import DocTestController, DocTestDefaults

    args = DocTestDefaults()
    # args.installed = True
    args.environment = "sage.all__sagemath_categories"
    args.global_iterations = 0
    args.file_iterations = 0
    args.verbose = True
    sage_path = Path(sage.env.__file__).parent
    DC = DocTestController(args, [str(sage_path / file) for file in files])
    err = DC.run()
    assert err == 0
